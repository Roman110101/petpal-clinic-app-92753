import { GoogleGenerativeAI } from '@google/generative-ai';

// Используем демо ключ для тестирования (в продакшене нужен настоящий API ключ)
const API_KEY = 'AIzaSyBkKzQrWjQrWjQrWjQrWjQrWjQrWjQrWjQ'; // Демо ключ

const genAI = new GoogleGenerativeAI(API_KEY);

// Системный промпт для ветеринарного помощника
const SYSTEM_PROMPT = `
Ты - виртуальный помощник ветеринарной клиники "Море". 

ТВОЯ РОЛЬ:
- Дружелюбный и профессиональный помощник
- Специализируешься на вопросах о здоровье животных
- Помогаешь с записью на приём и общими вопросами о клинике

ИНФОРМАЦИЯ О КЛИНИКЕ:
- Название: Ветеринарная клиника "Море"
- 4 филиала в Москве
- Работаем 24/7
- Экстренная помощь: +7 (495) 234-56-78
- Услуги: терапия, хирургия, диагностика, вакцинация, груминг

ПРАВИЛА ОТВЕТОВ:
1. Отвечай кратко и по делу (максимум 2-3 предложения)
2. При серьёзных симптомах ВСЕГДА рекомендуй очную консультацию
3. Не ставь диагнозы - только общие рекомендации
4. Предлагай записаться на приём при необходимости
5. Используй дружелюбный тон
6. Отвечай только на русском языке

ПРИМЕРЫ ХОРОШИХ ОТВЕТОВ:
- "Понимаю ваше беспокойство. Рекомендую показать питомца нашему терапевту для точного диагноза."
- "Это может быть признаком стресса. Попробуйте создать спокойную обстановку и запишитесь на консультацию."
- "Наша клиника работает круглосуточно. Могу помочь записаться на удобное время?"
`;

export class AIAssistant {
  private model;

  constructor() {
    this.model = genAI.getGenerativeModel({ 
      model: "gemini-pro",
      generationConfig: {
        temperature: 0.7,
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 200,
      }
    });
  }

  async getResponse(userMessage: string): Promise<string> {
    try {
      // Для демо версии используем предустановленные ответы
      return this.getDemoResponse(userMessage);
    } catch (error) {
      console.error('AI Assistant Error:', error);
      return "Извините, временные технические неполадки. Пожалуйста, позвоните нам: +7 (495) 234-56-78";
    }
  }

  private getDemoResponse(message: string): string {
    const lowerMessage = message.toLowerCase();
    
    // Более точные ключевые слова и соответствующие ответы
    const responses = {
      // Цены и прайс
      'цен': 'Актуальные цены смотрите в разделе "Прайс-лист" в меню или звоните +7 (495) 234-56-78. Стоимость зависит от услуги.',
      'прайс': 'Прайс-лист доступен в главном меню приложения. Также можете уточнить цены по телефону +7 (495) 234-56-78.',
      'стоимость': 'Стоимость услуг зависит от конкретной процедуры. Посмотрите прайс-лист в меню или позвоните нам.',
      
      // Запись на приём
      'запис': 'Записаться можно через приложение в разделе "Запись на приём" или по телефону +7 (495) 234-56-78. Работаем 24/7!',
      'приём': 'Для записи на приём используйте раздел "Запись" в приложении или звоните. Принимаем круглосуточно.',
      
      // Режим работы
      'режим': 'Работаем круглосуточно, 7 дней в неделю. 4 филиала в Москве. Экстренная помощь 24/7.',
      'время': 'Клиника работает 24 часа в сутки без выходных. Всегда готовы помочь вашему питомцу.',
      'работа': 'Наша клиника работает круглосуточно. У нас 4 филиала для вашего удобства.',
      
      // Экстренные случаи
      'экстрен': 'Экстренная помощь: +7 (495) 234-56-78. Работаем 24/7. При серьёзных симптомах приезжайте немедленно!',
      'срочно': 'При срочных случаях звоните +7 (495) 234-56-78 или приезжайте в любой из 4 филиалов. Работаем круглосуточно.',
      
      // Здоровье животных
      'аппетит': 'Потеря аппетита - серьёзный симптом. Рекомендую срочно показать питомца врачу. Записаться можно через приложение.',
      'рвота': 'Рвота требует внимания ветеринара. Если повторяется - срочно к врачу. Звоните +7 (495) 234-56-78.',
      'температура': 'Высокая температура - опасный симптом! Срочно к ветеринару. Принимаем без записи при экстренных случаях.',
      
      // Услуги
      'вакцин': 'Вакцинация проводится по графику. Запишитесь к терапевту для составления плана прививок.',
      'операц': 'Хирургические операции проводят опытные врачи. Необходима предварительная консультация и обследование.',
      'анализ': 'Лабораторные анализы делаем в клинике. Результаты готовы в день обращения.',
      
      // Животные
      'кот': 'Что именно беспокоит у кота? Опишите симптомы, и я подскажу, нужна ли срочная помощь.',
      'кошк': 'Что происходит с кошкой? Расскажите о симптомах для оценки ситуации.',
      'собак': 'Что случилось с собакой? Опишите проблему, помогу определить срочность.',
      'щенок': 'Щенки требуют особого внимания. Расскажите, что беспокоит, дам рекомендации.',
      'котёнок': 'У котят здоровье может меняться быстро. Опишите симптомы для оценки ситуации.'
    };

    // Поиск наиболее подходящего ответа
    for (const [keyword, response] of Object.entries(responses)) {
      if (lowerMessage.includes(keyword)) {
        return response;
      }
    }

    // Приветствия
    if (lowerMessage.includes('привет') || lowerMessage.includes('здравств')) {
      return 'Привет! Я AI помощник клиники "Море". Помогу с вопросами о здоровье питомцев, записи и услугах. Что вас интересует?';
    }

    // Благодарности
    if (lowerMessage.includes('спасибо') || lowerMessage.includes('благодар')) {
      return 'Пожалуйста! Рад помочь. Если есть ещё вопросы - обращайтесь. Здоровья вашему питомцу!';
    }

    // Общие ответы для неопознанных сообщений
    const generalResponses = [
      'Не совсем понял ваш вопрос. Можете уточнить? Помогу с записью, ценами или вопросами о здоровье питомца.',
      'Расскажите подробнее, чем могу помочь? Отвечу на вопросы о клинике, услугах или здоровье животных.',
      'Чем конкретно могу помочь? Готов ответить на вопросы о записи, ценах, режиме работы или здоровье питомца.'
    ];

    return generalResponses[Math.floor(Math.random() * generalResponses.length)];
  }
}

export const aiAssistant = new AIAssistant();
